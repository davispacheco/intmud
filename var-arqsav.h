#ifndef VAR_ARQSAV_H
#define VAR_ARQSAV_H

class TVariavel;
class TVarInfo;
class TClasse;
class TObjeto;

//----------------------------------------------------------------------------
class TVarSav /// Variável arqsav
{
public:
    static const TVarInfo * Inicializa();
        ///< Inicializa variável e retorna informações
    static void ProcEventos(int tempoespera);
        ///< Processa eventos
    static int Tempo(const char * arqnome);
        ///< Obtém a quantidade de minutos para expirar
        /**< @return quantidade de minutos ou 0=expirou, -1=nunca expira */

private:
    static bool ObterVar(TVariavel * var, TObjeto * obj, const char * nomevar);
        ///< Obtém uma variável "sav" a partir do nome e objeto
        /**< @param var Aonde colocar os dados da variável
         *   @param obj Objeto que contém a variável
         *   @param nomevar Nome da variável
         *   @return verdadeiro se sucesso, falso se falha (var->defvar=0) */
    static int Ler(TVariavel * v, const char * arqnome);
        ///< Lê um arquivo salvo; usado internamente
        /**< @param v Argumentos
         *   @param arqnome Nome do arquivo
         *   @return Quantidade de objetos lidos */
    static int Salvar(TVariavel * v, const char * arqnome, bool senhacod);
        ///< Salva um arquivo; usado internamente
        /**< @param v Argumentos
         *   @param arqnome Nome do arquivo
         *   @param senhacod Se a senha já está codificada
         *   @return 1 se conseguiu salvar, 0 se não conseguiu */
    static void Senha(char * senhacodif, const char * senha, char fator);
        ///< Codifica senha
    static bool InicVar;
        ///< Se já inicializou variáveis
    static int HoraReg;
        ///< Tempo que corresponde a dia, hora e minuto
    static int TempoSav;
        ///< Quanto tempo checou arquivos pendentes pela última vez

    static bool FuncLimpar(TVariavel * v);     ///< Processa função Limpar
    static bool FuncLimpou(TVariavel * v);     ///< Processa função Limpou
    static bool FuncSenhaCod(TVariavel * v);   ///< Processa função SenhaCod
    static bool FuncValido(TVariavel * v);     ///< Processa função Valido
    static bool FuncExiste(TVariavel * v);     ///< Processa função Existe
    static bool FuncSenha(TVariavel * v);      ///< Processa função Senha
    static bool FuncDias(TVariavel * v);       ///< Processa função Dias
    static bool FuncLer(TVariavel * v);        ///< Processa função Ler
    static bool FuncSalvar(TVariavel * v);     ///< Processa função Salvar
    static bool FuncSalvarCod(TVariavel * v);  ///< Processa função SalvarCod
    static bool FuncApagar(TVariavel * v);     ///< Processa função Apagar

    static bool FGetBool(TVariavel * v);
    static int FGetInt(TVariavel * v);
    static double FGetDouble(TVariavel * v);
    static const char * FGetTxt(TVariavel * v);
    static TObjeto * FGetObj(TVariavel * v);
};

//----------------------------------------------------------------------------
class TVarSavDir /// Diretórios pendentes - para checar arquivos expirados
{
    TVarSavDir(const char * nomedir); ///< Construtor
public:
    ~TVarSavDir();  ///< Destrutor
    static void NovoDir(const char * nomedir);
        ///< Acrescenta um diretório na lista de busca
    static bool Checa();
        ///< Checa alguns arquivos pendentes
        /**< @return true se ainda tem arquivos pendentes
             @note Deve ser chamado de tempos em tempos, até retornar false */
    static void ChecaTudo();
        ///< Checa todos os arquivos pendentes
    static bool ChecaPend();
        ///< Retorna true se tem algum arquivo pendente

private:
    void RBinsert(void);        ///< Insere objeto na RBT
    void RBremove(void);        ///< Remove objeto da RBT
    static TVarSavDir * RBfirst(void); ///< Primeiro objeto da RBT
    static TVarSavDir * RBlast(void);  ///< Último objeto da RBT
    static TVarSavDir * RBnext(TVarSavDir *); ///< Próximo objeto da RBT
    static TVarSavDir * RBprevious(TVarSavDir *); ///< Objeto anterior da RBT
    static int RBcomp(TVarSavDir * x, TVarSavDir * y); ///< Compara objetos
    static TVarSavDir * RBroot;  ///< Objeto raiz
    TVarSavDir *RBleft,*RBright,*RBparent; ///< Objetos filhos e objeto pai
    void RBleft_rotate(void);
    void RBright_rotate(void);
    unsigned char RBcolour;

    static TVarSavDir * Inicio; ///< endereço do primeiro objeto
    static TVarSavDir * Fim; ///< endereço do último objeto
    TVarSavDir * Proximo; ///< Endereço do próximo objeto

    char * Nome; ///< Nome do diretório que deve procurar
};

//----------------------------------------------------------------------------
class TVarSavArq /// Nomes dos arquivos apagados por arqsav por terem expirado
{
public:
    TVarSavArq(const char * nome); ///< Construtor
    ~TVarSavArq();              ///< Destrutor
    TVarSavArq * Antes;         ///< Objeto anterior
    TVarSavArq * Depois;        ///< Próximo objeto
    static TVarSavArq * Inicio; ///< Primeiro objeto
    static TVarSavArq * Fim;    ///< Último objeto
    char Nome[128];             ///< Nome do arquivo
};

//----------------------------------------------------------------------------

#endif
